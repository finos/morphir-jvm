name: Scala CI

env:
  JDK_JAVA_OPTIONS: -XX:+PrintCommandLineFlags -Xmx3G # JDK_JAVA_OPTIONS is _the_ env. variable to use for modern Java
  JVM_OPTS: -XX:+PrintCommandLineFlags -Xmx3G # for Java 8 only (sadly, it is not modern enough for JDK_JAVA_OPTIONS)


on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]
  release:
    types: [published]
    
jobs:
  test:
    runs-on: ubuntu-20.04
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        java: ['adopt@1.8', 'adopt@1.11']
        scala: ['2.11.12', '2.12.13', '2.13.6', '3.0.1']
        platform: ['JVM', 'JS']
    steps:
      - name: Checkout current branch
        uses: actions/checkout@v2.3.4
      - name: Setup Scala and Java
        uses: olafurpg/setup-scala@v12
        with:
          java-version: ${{ matrix.java }}

  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Pull all history with tags for correct versionning
      run: git fetch --prune --unshallow
    - name: Set up JDK 1.8
      uses: actions/setup-java@v1
      with:
        java-version: 1.8

    - name: Cache SBT ivy cache
      uses: actions/cache@v1
      with:
        path: ~/.ivy2/cache
        key: ${{ runner.os }}-sbt-ivy-cache-${{ hashFiles('**/build.sc') }}
        restore-keys: |
          ${{ runner.os }}-sbt-ivy-cache-

    - name: Cache SBT
      uses: actions/cache@v1
      with:
        path: ~/.sbt
        key: ${{ runner.os }}-sbt-${{ hashFiles('**/build.sc') }}
        restore-keys: |
          ${{ runner.os }}-sbt-

    - name: Cache Mill
      uses: actions/cache@v1
      with:
        path: ~/.cache/mill
        key: ${{ runner.os }}-mill-${{ hashFiles('**/build.sc') }}
        restore-keys: |
          ${{ runner.os }}-mill-

    - name: Cache Coursier
      uses: actions/cache@v1
      with:
        path: ~/.cache/coursier
        key: ${{ runner.os }}-coursier-${{ hashFiles('**/build.sc') }}
        restore-keys: |
          ${{ runner.os }}-coursier-

    - name: Cache Out
      uses: actions/cache@v1
      with:
        path: ./out
        key: ${{ runner.os }}-out-${{ hashFiles('**/build.sc') }}
        restore-keys: |
          ${{ runner.os }}-out-

    - name: Checks
      run: |
        git config --global user.name "CI"
        ./mill all __.checkFormat __.docJar __.test
      #  ./mill all __.checkFormat "__.fix --check" __.docJar __.test

    - name: Status Check
      run: |
        git status

    - name: Publish
      if: github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/v') || github.event_name == 'release'
      run: |
        echo "${{ secrets.PGP_SECRET }}" > private.key
        gpg --batch --yes --import private.key
        rm private.key

        ./mill mill.scalalib.PublishModule/publishAll --sonatypeCreds ${{ secrets.SONATYPE_USERNAME }}:${{ secrets.SONATYPE_PASSWORD }} --gpgArgs --passphrase,${{ secrets.PGP_PASSPHRASE }},--batch,--yes,-a,-b,--pinentry-mode,loopback --publishArtifacts __.publishArtifacts --awaitTimeout 900000 --readTimeout 600000 --release true
